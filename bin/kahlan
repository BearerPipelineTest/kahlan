#!/usr/bin/env php
<?php
if (!defined('DS')) {
    define('DS', DIRECTORY_SEPARATOR);
}

error_reporting(E_ALL);

$autoload = require __DIR__ . '/../autoload.php';
$autoloader = $autoload();

use Kahlan\Box\Box;
use Kahlan\Suite;
use Kahlan\Cli\Kahlan;
use Kahlan\Jit\ClassLoader;

$box = \Kahlan\box('kahlan', new Box());

$box->service('suite.global', function() {
    return new Suite();
});

$specs = new Kahlan([
    'autoloader' => $autoloader,
    'suite'      => $box->get('suite.global')
]);
$specs->loadConfig($argv);
initKahlanGlobalFunctions();

if ($autoloader instanceof ClassLoader) {
    $commandLine = $specs->commandLine();
    $autoloader->patch([
        'include'    => $commandLine->get('include'),
        'exclude'    => array_merge($commandLine->get('exclude'), ['Kahlan\\']),
        'persistent' => $commandLine->get('persistent'),
        'cachePath'  => rtrim(realpath(sys_get_temp_dir()), DS) . DS . 'kahlan',
        'clearCache' => $commandLine->get('cc')
    ]);

    $specs->initPatchers();

    foreach ($autoloader->files() as $fileIdentifier => $file) {
        if (!empty($GLOBALS['__composer_autoload_files'][$fileIdentifier])) {
            continue;
        }
        $autoloader->loadFile($file);
        $GLOBALS['__composer_autoload_files'][$fileIdentifier] = true;
    }
}

$specs->run();
exit($specs->status());
